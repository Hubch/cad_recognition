# 软著撰写的代码参考及说明

视觉代码分为两部分：训练和部署。其中训练又分为单目标检测模型训练和匹配模型两部分，但检测模型训练完全基于 yolov5 进行，没有进行太多改动。本说明主要介绍匹配模型训练和算法部署的思路和实现，以供参考。

## 软件功能及实现步骤
0. 软件功能为比对两幅CAD 图纸是否描述的相同实体，更进一步地描述其差异点。
1. 网页端接收 pdf 或其他格式高分辨率 CAD 图纸，解析为 PNG 格式送入 modelserver 处理。
2. modelserver 通过 letterbox 方法对齐两幅图纸到相同尺寸，同时保持其长宽比例不变。
3. modelserver 使用滑动窗口方法将两幅图纸切分为两组位置上一一对应的图像组，其中每一幅图像的尺寸均相同。
4. 考虑到滑窗交界处可能出现目标被切割的现象，滑窗的步长将略小于窗口尺寸，从而产生交界处的重叠。
5. 将切分后的图像组组合为 batch 送入目标检测模型进行位置检测，并得到每一个目标在每一个子图中的局域坐标。
6. 由滑动窗口的尺寸和步长将上一步得到的局域坐标恢复为全局坐标，同时将切分后的子图恢复为高分辨率图纸。
7. 由于滑窗间重叠区域的存在，对恢复后的全局坐标进行全局非极大值抑制。由于我们使用了单目标检测模型，配合较低的IOU阈值。这一步几乎可以完全避免重叠框的存在。
8. 使用加权匈牙利（暂用，可选）等目标匹配算法进行位置上的初步匹配，将两幅图纸中的每一个目标进行位置上的初步对应，形成一个目标对组（group of object-pairs）。
9. 使用目标匹配模型对上一步得到的目标对组中的每一对目标进行匹配，得到更确切的类别上的对应。
10. 根据预先设定的阈值和实际的位置匹配率、类别匹配率判定两幅图纸描述的是否为相同实体。
11. 对两幅图纸中的每一个目标给定结构化信息，包括：位置、是否在图例库中有对应、（如有）类别、是否在对手图纸有对应、（如有）对应目标的位置，LLM 描述。
12. 对两幅图纸整体进行LLM描述。
13. 组合以上三条为结构化的 json 文件，返回给网页端进行解析。

## 匹配模型

匹配模型的实现主要实现在 det_matrices/train_matrices.py, det_matrices/_utils/datasets.py, det_matrices/_utils/loss_functions.py, det_matrices/_utils/matrices.py, det_matrices/_utils/models.py  包括以下几个部分：

1. 模型架构：
   - 教师模型：使用ConvNeXt Tiny作为基础网络，修改第一层卷积以接受单通道输入。
   - 学生模型：使用MobileNetV2作为基础网络，同样修改第一层卷积以接受单通道输入。
   - 两个模型都添加了特征提取和分类头，输出特征向量和类别logits。

2. 损失函数：
   - 组合了多个损失函数，包括Triplet Loss、NT-Xent Loss、ArcFace Loss、分类损失、BYOL自监督损失和蒸馏损失。
   - 使用动态权重平衡不同损失的贡献。

3. 训练策略：
   - 采用教师-学生模型结构，先训练教师模型，再使用教师模型指导学生模型的训练。
   - 使用AdaBelief优化器和Lookahead优化策略。
   - 实现了学习率调度、梯度裁剪等技巧。

4. 数据处理：
   - 使用自定义数据集类CombinedDataset，支持triplet采样。
   - 实现了数据增强，包括随机翻转、旋转、裁剪、颜色抖动等。
   - 使用CLAHE（对比度受限自适应直方图均衡化）进行图像预处理。

5. 评估指标：
   - 使用欧氏距离和余弦相似度计算样本间距离。
   - 实现了阈值优化算法，用于确定最佳匹配阈值。
   - 评估指标包括分类准确率、匹配准确率（正样本和负样本）、F1分数等。

6. 其他技巧：
   - 实现了模型权重的冻结和更新策略。
   - 使用TensorBoard进行训练过程的可视化。
   - 实现了模型权重的保存和加载功能。

## modelserver

modelserver 是基于 Ray Serve 框架实现的高效、可扩展的服务端部署方案，主要实现在 modelserver/cad_detect.py, modelserver/pipeline.py ，包含以下几个部分：

1. 数据预处理：
   - 实现了 PDF 文件到高分辨率 PNG 图像的转换功能。
   - 使用 letterbox 方法对齐两幅图纸到相同尺寸，同时保持其长宽比例不变。

2. 图像分割与处理：
   - 实现了滑动窗口方法，将大尺寸图纸切分为一系列小尺寸图像。
   - 设置滑动窗口的步长略小于窗口尺寸，确保交界处有重叠，避免目标被切割。
   - 将切分后的图像组合为 batch，以提高处理效率。

3. 目标检测：
   - 使用 ONNX Runtime 加载和运行 ONNX 格式的检测模型。
   - 对每个子图进行目标检测，得到局部坐标系下的目标位置。

4. 坐标恢复与后处理：
   - 实现了从局部坐标到全局坐标的恢复算法，考虑滑动窗口的位置和尺寸。
   - 对恢复后的全局坐标进行全局非极大值抑制，解决重叠区域可能产生的重复检测问题。

5. 目标匹配：
   - 实现了基于位置的初步匹配算法，如加权匈牙利算法。
   - 使用 ONNX Runtime 加载和运行 ONNX 格式的匹配模型，对初步匹配的目标对进行精确匹配。

6. 结果分析与生成：
   - 根据预设阈值和实际的位置匹配率、类别匹配率判定两幅图纸是否描述相同实体。
   - 为每个检测到的目标生成结构化信息，包括位置、类别、对应关系等。
   - 集成 LLM 模型，对图纸整体和个别目标进行描述。

7. 服务接口设计：
   - 使用 Ray Serve 的 `@serve.deployment` 装饰器部署服务。
   - 实现了 `CADDetect` 类作为主要服务接口，处理 HTTP 请求和响应。
   - 设计了结构化的 JSON 格式，用于前后端数据交互。

8. 并发和资源管理：
   - 利用 Ray Serve 的特性，实现了服务的并发处理。
   - 为 `CADDetect` 部署指定了精确的 CPU 和 GPU 资源需求，确保高效利用硬件资源。

9. 错误处理和日志：
   - 实现了全面的错误处理机制，包括输入验证、模型推理异常处理等。
   - 集成了详细的日志记录功能，便于问题诊断和性能优化。

10. 性能优化：
    - 实现了图像处理和模型推理的批处理机制，提高throughput。
    - 使用异步处理方法，提高并发性能。

11. 安全性考虑：
    - 实现了输入数据的验证和清洗，防止恶意输入。
    - 集成了基本的认证和授权机制，确保API的安全访问。

通过这种全面的服务端部署方案，CAD 图纸比对功能被封装为一个高效、可靠、安全的 Web 服务，能够处理各种复杂的图纸比对需求，并为前端提供丰富的结构化结果，便于进一步的可视化和分析。
